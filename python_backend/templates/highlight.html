{% extends "base.html" %}
{% block title %}Debug Highlight Page{% endblock %}

{% block styles %}
<style>
  /* Ensure the viewport is set in your base.html head:
     <meta name="viewport" content="width=device-width, initial-scale=1">
  */

  /* On desktop, the canvas stays at 600x400 */
  /* For mobile screens, let the canvas scale down */
  @media (max-width: 768px) {
    .container {
      padding: 10px;
    }
    /* Scale canvas to fit the device width, maintaining aspect ratio */
    #highlightCanvas {
      width: 100% !important;
      height: auto !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container text-center my-3">
  <h3>Debug Highlight Page</h3>
  <p>Check your DevTools network tab to ensure the image is actually loading.</p>

  <!-- Tool Buttons -->
  <div class="mb-3">
    <button id="highlightToolBtn" class="btn btn-primary me-2">Highlight (Freehand)</button>
    <button id="rectSelectToolBtn" class="btn btn-secondary">Rect. Select</button>
  </div>

  <!-- Canvas Container -->
  <div style="display: inline-block; border: 1px solid #ccc;">
    <canvas id="highlightCanvas" width="600" height="400" style="border: 1px solid #000;"></canvas>
  </div>

  <!-- Finish Button -->
  <div class="mt-3">
    <button id="finishBtn" class="btn btn-success">Finish</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
<script>
  const canvas = new fabric.Canvas('highlightCanvas');

  // Use a known placeholder or local path for the image
  const imageUrl = "/static/image.png";
  fabric.Image.fromURL(imageUrl, function (img) {
    img.set({ left: 0, top: 0, selectable: false });
    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
  }, { crossOrigin: 'anonymous' });

  function enableHighlightTool() {
    canvas.isDrawingMode = true;
    canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
    canvas.freeDrawingBrush.color = 'rgba(183, 252, 98, 255)';
    canvas.freeDrawingBrush.width = 15;
    canvas.off('mouse:down');
    canvas.off('mouse:move');
    canvas.off('mouse:up');
    console.log("Freehand highlight tool enabled");
  }

  function enableRectTool() {
    canvas.isDrawingMode = false;
    canvas.off('mouse:down');
    canvas.off('mouse:move');
    canvas.off('mouse:up');

    let rect, isDown, origX, origY;
    canvas.on('mouse:down', function (o) {
      isDown = true;
      const pointer = canvas.getPointer(o.e);
      origX = pointer.x;
      origY = pointer.y;
      rect = new fabric.Rect({
        left: origX,
        top: origY,
        width: 0,
        height: 0,
        fill: 'transparent',
        stroke: 'blue',
        strokeWidth: 2,
        selectable: false,
      });
      canvas.add(rect);
    });

    canvas.on('mouse:move', function (o) {
      if (!isDown) return;
      const pointer = canvas.getPointer(o.e);
      rect.set({
        width: Math.abs(origX - pointer.x),
        height: Math.abs(origY - pointer.y)
      });
      if (pointer.x < origX) {
        rect.set({ left: pointer.x });
      }
      if (pointer.y < origY) {
        rect.set({ top: pointer.y });
      }
      canvas.renderAll();
    });

    canvas.on('mouse:up', function () {
      isDown = false;
      canvas.off('mouse:down');
      canvas.off('mouse:move');
      canvas.off('mouse:up');
    });
    console.log("Rectangle tool enabled");
  }

  document.getElementById('highlightToolBtn').addEventListener('click', enableHighlightTool);
  document.getElementById('rectSelectToolBtn').addEventListener('click', enableRectTool);

  document.getElementById('finishBtn').addEventListener('click', () => {
    const objects = canvas.getObjects();
    console.log("Objects:", objects);
    alert("Finish clicked. Check console for objects data.");
  });

  // Default to highlight tool
  enableHighlightTool();
</script>
{% endblock %}
